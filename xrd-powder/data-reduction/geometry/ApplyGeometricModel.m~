function fout = ApplyGeometricModel(x)
centers     = [x(1) x(2)]./1000;
distance    = x(3);
gX          = x(4);
gY          = x(5);

pkidx           = evalin('base','[XRDIMAGE.Material.pkidx{:}]');
tth             = evalin('base','tth');
azim            = evalin('base','XRDIMAGE.CakePrms.azim');
rho             = evalin('base','pkfit.rho')';
dettype         = evalin('base','XRDIMAGE.Instr.dettype');
find_detpars    = evalin('base','Analysis_Options.find_detpars');

tth = tth(pkidx);
if find_detpars
    distPars    = x(6:end);
else
    distPars    = evalin('base','XRDIMAGE.Instr.detpars')';
end

mapped_tth  = GeometricModelXRDSwitch(XRDIMAGE.Instr, polimg);

if strcmp(dettype,'0')
    mapped_tth  = GeometricModelXRD0(...
        centers, ...
        distance, ...
        gY, gX, ...
        rho, azim);
elseif strcmp(dettype,'1')
    mapped_tth  = GeometricModelXRD1(...
        centers, ...
        distance, ...
        gY, gX, ...
        rho, azim, distPars);
elseif strcmp(dettype,'2')
    mapped_tth  = GeometricModelXRD2(...
        centers, ...
        distance, ...
        gY, gX, ...
        rho, azim, distPars);
elseif strcmp(dettype,'2a')
    mapped_tth  = GeometricModelXRD2a(...
        centers, ...
        distance, ...
        gY, gX, ...
        rho, azim, distPars);
elseif strcmp(dettype,'2b')
    mapped_tth  = GeometricModelXRD2b(...
        centers, ...
        distance, ...
        gY, gX, ...
        rho, azim, distPars);
end

tth     = repmat(tth,size(mapped_tth,2),1)';
fout    = tth - mapped_tth;
